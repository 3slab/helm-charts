---
# Source: sftp/templates/configmap.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-sftp-bindmount
  labels:
    app.kubernetes.io/name: sftp
    helm.sh/chart: sftp-1.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
data:
  bindmount.sh: |-
    #!/bin/bash
    # File mounted as: /etc/sftp.d/bindmount.sh
    # Just an example (make your own)
    
    function bindmount() {
        if [ -d "$1" ]; then
            mkdir -p "$2"
        fi
        mount --bind $3 "$1" "$2"
    }
    
    # Remember permissions, you may have to fix them:
    # chown -R :users /data/common
    
    # bindmount /data/admin-tools /home/admin/tools
    # bindmount /data/common /home/dave/common
    # bindmount /data/common /home/peter/common
    # bindmount /data/docs /home/peter/docs --read-only
---
# Source: sftp/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: release-name-sftp
  labels:
    app.kubernetes.io/name: sftp
    helm.sh/chart: sftp-1.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 22
      targetPort: ssh
      protocol: TCP
      name: ssh
  selector:
    app.kubernetes.io/name: sftp
    app.kubernetes.io/instance: release-name
---
# Source: sftp/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: release-name-sftp
  labels:
    app.kubernetes.io/name: sftp
    helm.sh/chart: sftp-1.1.0
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: sftp
      app.kubernetes.io/instance: release-name
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sftp
        app.kubernetes.io/instance: release-name
    spec:
      restartPolicy: Always
      containers:
        - name: sftp
          image: "atmoz/sftp:latest"
          imagePullPolicy: IfNotPresent
          ports:
            - name: ssh
              containerPort: 22
              protocol: TCP
          securityContext:
            privileged: true
            capabilities:
              add: ["SYS_ADMIN"]
          volumeMounts:
            - mountPath: /etc/sftp.d/bindmount.sh
              name: sftp-bindmount-vol
              subPath: bindmount.sh
          resources:
            {}
      volumes:
        - name: sftp-bindmount-vol
          configMap:
            name: release-name-sftp-bindmount
            defaultMode: 0777
